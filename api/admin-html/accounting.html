<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ChamCard Admin - المحاسبة</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">C</div>
            <span>ChamCard</span>
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html">لوحة التحكم</a></li>
            <li><a href="transactions.html">العمليات</a></li>
            <li><a href="accounting.html" class="active">المحاسبة</a></li>
            <li><a href="customers.html">العملاء</a></li>
            <li><a href="cards.html">البطاقات</a></li>
            <li><a href="validators.html">أجهزة الباص</a></li>
            <li><a href="audit.html">سجل التدقيق</a></li>
            <li style="margin-top: auto; padding-top: 40px;">
                <a href="#" onclick="logout()" style="color: var(--danger-red);">تسجيل خروج</a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <header>
            <h1>المحاسبة</h1>
            <div id="adminName" style="font-weight: 700; color: var(--primary-blue);">أدمن</div>
        </header>

        <div class="card-container">
            <div style="padding: 18px 20px; font-weight: 900; border-bottom: 1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color: var(--primary-blue);">●</span>
                    <span>ملخّص المحاسبة</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input id="acctDate" type="date" style="background: var(--card-bg); border:1px solid var(--border-color); padding:10px 12px; border-radius:10px; color: var(--text-primary);" />
                    <button class="btn" onclick="loadAccounting()">تحديث</button>
                </div>
            </div>
            <div style="padding: 18px 20px;" id="acctTotals"></div>
        </div>

        <div class="card-container" style="margin-top: 16px;">
            <div style="padding: 18px 20px; font-weight: 900; border-bottom: 1px solid var(--border-color); display:flex; align-items:center; gap:10px;">
                <span style="color: #22c55e;">●</span>
                <span>تفصيل حسب جهاز التحقق (Validator)</span>
            </div>
            <div style="padding: 14px 20px; overflow:auto;">
                <table class="table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">الـ Validator</th>
                            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">دخل</th>
                            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">مدفوع</th>
                            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">متبقّي</th>
                            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">حركات</th>
                            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="acctRows"></tbody>
                </table>
            </div>
        </div>

        <!-- Payout modal -->
        <div id="payoutModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding:18px;">
            <div style="width:min(520px, 100%); background: var(--card-bg); border:1px solid var(--border-color); border-radius:16px; overflow:hidden;">
                <div style="padding: 16px 18px; font-weight: 900; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <div>تسجيل صرف (تسوية)</div>
                    <button class="btn" onclick="closePayout()" style="background:transparent; border:1px solid var(--border-color);">إغلاق</button>
                </div>
                <div style="padding: 16px 18px; display:grid; gap:12px;">
                    <div>
                        <div style="font-size:0.85rem; color: var(--text-secondary); margin-bottom:6px;">Validator</div>
                        <input id="payoutValidator" disabled style="width:100%; background: #0b1220; border:1px solid var(--border-color); padding:12px; border-radius:12px; color: var(--text-primary);" />
                    </div>
                    <div>
                        <div style="font-size:0.85rem; color: var(--text-secondary); margin-bottom:6px;">المبلغ</div>
                        <input id="payoutAmount" type="number" inputmode="numeric" style="width:100%; background: #0b1220; border:1px solid var(--border-color); padding:12px; border-radius:12px; color: var(--text-primary);" />
                    </div>
                    <div>
                        <div style="font-size:0.85rem; color: var(--text-secondary); margin-bottom:6px;">طريقة الدفع</div>
                        <select id="payoutMethod" style="width:100%; background: #0b1220; border:1px solid var(--border-color); padding:12px; border-radius:12px; color: var(--text-primary);">
                            <option value="cash">نقداً</option>
                            <option value="bank">تحويل/بنك</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div>
                        <div style="font-size:0.85rem; color: var(--text-secondary); margin-bottom:6px;">ملاحظة (اختياري)</div>
                        <input id="payoutNote" placeholder="مثال: تسوية نهاية اليوم" style="width:100%; background: #0b1220; border:1px solid var(--border-color); padding:12px; border-radius:12px; color: var(--text-primary);" />
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-start;">
                        <button class="btn" onclick="submitPayout()">حفظ</button>
                        <button class="btn" onclick="closePayout()" style="background:transparent; border:1px solid var(--border-color);">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        window.onload = async () => {
            if (await checkAuth()) {
                loadAccounting();
            }
        };
    </script>
</body>
</html>
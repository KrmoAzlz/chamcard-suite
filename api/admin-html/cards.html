<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة البطاقات | ChamCard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="logo"><div class="logo-icon">C</div><span>ChamCard</span></div>
        <ul class="nav-links">
            <li><a href="dashboard.html">لوحة التحكم</a></li>
            <li><a href="transactions.html">العمليات</a></li>
            <li><a href="accounting.html">المحاسبة</a></li>
            <li><a href="customers.html">العملاء</a></li>
            <li><a href="cards.html" class="active">البطاقات</a></li>
            <li><a href="validators.html">أجهزة الباص</a></li>
            <li><a href="audit.html">سجل التدقيق</a></li>
        </ul>
    </div>

    <div class="main-content">
        <header>
            <h1>أمان وسائل الدفع (NFC/QR)</h1>
        </header>

        <div style="margin-bottom: 25px; display: flex; gap: 10px;">
            <input type="text" id="uidSearch" placeholder="بحث بـ UID البطاقة..." style="width: 350px;">
            <button class="btn btn-primary" onclick="handleCardSearch()">تحقق من الحالة</button>
        </div>

        <div class="card-container">
            <table id="cardsTable">
                <thead>
                    <tr>
                        <th>UID</th>
                        <th>المستخدم</th>
                        <th>محاولات مرفوضة</th>
                        <th>الحالة</th>
                        <th>إجراءات الحظر</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        async function handleCardSearch() {
            const uid = document.getElementById('uidSearch').value;
            const data = await apiRequest(`/admin/cards?query=${uid}`);
            const tbody = document.querySelector('#cardsTable tbody');
            if (!data || !tbody) return;

            tbody.innerHTML = data.map(card => `
                <tr>
                    <td class="font-mono font-bold">${card.uid}</td>
                    <td>${card.customerId}</td>
                    <td style="color: ${card.fraudAttempts > 0 ? 'var(--danger-red)' : 'white'}">${card.fraudAttempts}</td>
                    <td><span class="badge ${card.status === 'ACTIVE' ? 'badge-success' : 'badge-danger'}">${card.status}</span></td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 12px; font-size: 0.7rem;" onclick="toggleCardStatus('${card.uid}', '${card.status}')">
                            ${card.status === 'ACTIVE' ? 'حظر البطاقة' : 'فك الحظر'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleCardStatus(uid, current) {
            const action = current === 'ACTIVE' ? 'block' : 'unblock';
            const reason = prompt(`سبب ${action === 'block' ? 'الحظر' : 'التنشيط'}:`);
            if (!reason) return;

            const res = await apiRequest(`/admin/cards/${uid}/${action}`, {
                method: 'POST',
                body: JSON.stringify({ reason })
            });

            if (res) {
                alert('تم تحديث الحالة بنجاح');
                handleCardSearch();
            }
        }
        window.onload = checkAuth;
    </script>
</body>
</html>